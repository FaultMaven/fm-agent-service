# Header Forwarding Requirements for End-to-End Observability

**Status**: ⚠️ **Partial Implementation - Enhancement Needed**

## Overview

The fm-agent-service logging middleware expects specific HTTP headers for correlation tracking and observability. This document outlines the header forwarding requirements and identifies gaps in the current fm-api-gateway implementation.

## Expected Headers (fm-agent-service)

The [LoggingMiddleware](src/agent_service/infrastructure/logging/middleware.py:36-47) extracts these headers:

```python
# From middleware.py (lines 36-47)
correlation_id = request.headers.get("X-Correlation-ID", str(uuid.uuid4()))
session_id = request.headers.get("X-Session-ID")
user_id = request.headers.get("X-User-ID")
case_id = request.headers.get("X-Case-ID")
```

### Header Purposes

| Header | Purpose | Source | Critical? |
|--------|---------|--------|-----------|
| `X-Correlation-ID` | Request tracing across services | Generated by gateway or client | ✅ Yes |
| `X-User-ID` | User identification | JWT token validation | ✅ Yes |
| `X-Session-ID` | Session tracking | Session service | ⚠️ Recommended |
| `X-Case-ID` | Troubleshooting case tracking | Case service | ⚠️ Optional |

## Current API Gateway Implementation

### ✅ What's Working

**File**: `/home/swhouse/product/fm-api-gateway/src/gateway/api/middleware.py`

The `AuthMiddleware` correctly:

1. **Validates JWT tokens** (lines 88-99)
2. **Strips malicious client headers** (lines 101-102) - prevents header injection
3. **Adds validated user headers** (lines 104-108):
   ```python
   # Lines 104-108
   validated_headers = user_context.to_headers()
   for header_name, header_value in validated_headers.items():
       request.state.user_headers = getattr(request.state, "user_headers", {})
       request.state.user_headers[header_name] = header_value
   ```

4. **Forwards headers to backend** (proxy_request in routes.py:76-78):
   ```python
   # Lines 76-78
   if hasattr(request.state, "user_headers"):
       headers.update(request.state.user_headers)
   ```

**Forwarded Headers** (from `UserContext.to_headers()`):
- ✅ `X-User-ID` (matches agent-service expectation)
- ✅ `X-User-Email`
- ✅ `X-User-Roles`
- ✅ `X-Email-Verified`

### ❌ What's Missing

The API Gateway **does NOT** currently forward:

1. **`X-Correlation-ID`** - Request tracing
   - **Impact**: Each microservice generates its own correlation ID
   - **Result**: Cannot trace requests across service boundaries
   - **Workaround**: Agent service generates new UUID (fallback working, but not ideal)

2. **`X-Session-ID`** - Session tracking
   - **Impact**: Cannot correlate logs by user session
   - **Result**: Harder to debug user-specific issues
   - **Workaround**: None currently

3. **`X-Case-ID`** - Case tracking
   - **Impact**: Cannot correlate logs by troubleshooting case
   - **Result**: Harder to track case-specific operations
   - **Workaround**: None currently

## Recommended Enhancements

### Enhancement 1: Add Correlation ID Generation

**File**: `fm-api-gateway/src/gateway/api/middleware.py`

Add correlation ID generation/forwarding to `AuthMiddleware.dispatch()`:

```python
async def dispatch(self, request: Request, call_next: Callable) -> Response:
    # Generate or extract correlation ID (add before line 59)
    correlation_id = request.headers.get("X-Correlation-ID", str(uuid.uuid4()))

    # Store in request.state for forwarding
    request.state.correlation_id = correlation_id

    # ... rest of existing code ...
```

**File**: `fm-api-gateway/src/gateway/api/routes.py`

Add to `proxy_request()` header forwarding:

```python
# Add after line 78
if hasattr(request.state, "correlation_id"):
    headers["X-Correlation-ID"] = request.state.correlation_id
```

### Enhancement 2: Add Session ID Forwarding (Optional)

If the session service provides a session ID in a header or the JWT token contains session information, forward it:

```python
# In AuthMiddleware.dispatch() after user validation
if hasattr(user_context, "session_id") and user_context.session_id:
    request.state.session_headers = {
        "X-Session-ID": user_context.session_id
    }

# In proxy_request()
if hasattr(request.state, "session_headers"):
    headers.update(request.state.session_headers)
```

### Enhancement 3: Add Case ID Passthrough (Optional)

Allow case-specific headers to pass through from client (if authenticated):

```python
# In AuthMiddleware.dispatch() after user validation
case_id = request.headers.get("X-Case-ID")
if case_id:
    request.state.case_headers = {"X-Case-ID": case_id}

# In proxy_request()
if hasattr(request.state, "case_headers"):
    headers.update(request.state.case_headers)
```

## Current Behavior vs. Ideal Behavior

### Current Flow (⚠️ Partial Correlation)

```
Client Request
    ↓
fm-api-gateway (generates no correlation ID)
    ↓ forwards: X-User-ID only
fm-agent-service (generates NEW UUID for correlation_id)
    ↓
Logs: {correlation_id: "abc123", user_id: "user456", session_id: null, case_id: null}
```

**Problem**: Each service has different correlation_id → cannot trace requests across services

### Ideal Flow (✅ Full Correlation)

```
Client Request (optional: X-Correlation-ID, X-Case-ID)
    ↓
fm-api-gateway (generates X-Correlation-ID if missing)
    ↓ forwards: X-Correlation-ID, X-User-ID, X-Session-ID, X-Case-ID
fm-agent-service (uses forwarded correlation_id)
    ↓
Logs: {correlation_id: "xyz789", user_id: "user456", session_id: "sess123", case_id: "case789"}
```

**Benefit**: Same correlation_id across all services → full distributed tracing

## Testing the Gap

### Current Test (shows gap)

```bash
# Make request to agent service via API Gateway
curl -X POST http://api-gateway:8090/api/v1/agent/query \
  -H "Authorization: Bearer <token>" \
  -H "X-Correlation-ID: test-correlation-123" \
  -H "X-Case-ID: test-case-456" \
  -H "Content-Type: application/json" \
  -d '{"query": "Help me debug"}'

# Check agent service logs
# Expected: correlation_id="test-correlation-123", case_id="test-case-456"
# Actual:   correlation_id="<random-uuid>", case_id=null
```

### After Enhancement (expected)

```bash
# Same request
curl -X POST http://api-gateway:8090/api/v1/agent/query \
  -H "Authorization: Bearer <token>" \
  -H "X-Correlation-ID: test-correlation-123" \
  -H "X-Case-ID: test-case-456" \
  -H "Content-Type: application/json" \
  -d '{"query": "Help me debug"}'

# Check agent service logs
# Expected: correlation_id="test-correlation-123", case_id="test-case-456"
# Actual:   correlation_id="test-correlation-123", case_id="test-case-456" ✅
```

## Impact Assessment

### Without Enhancement (Current)

**Pros**:
- ✅ User authentication works
- ✅ User ID propagates correctly
- ✅ Service still functional

**Cons**:
- ❌ Cannot trace requests across services (different correlation IDs)
- ❌ Cannot filter logs by session
- ❌ Cannot track case-specific operations
- ❌ Harder to debug distributed system issues

### With Enhancement (Recommended)

**Pros**:
- ✅ Full distributed tracing with consistent correlation ID
- ✅ Session-based log filtering and debugging
- ✅ Case-specific operation tracking
- ✅ Better alignment with monolith observability patterns
- ✅ Easier troubleshooting in production

**Cons**:
- ⚠️ Requires API Gateway changes
- ⚠️ Additional testing needed

## Priority Recommendation

### P0 (Critical): X-Correlation-ID
- **Impact**: High - enables distributed tracing
- **Effort**: Low - simple UUID generation/forwarding
- **Timeline**: Implement immediately

### P1 (High): X-Session-ID
- **Impact**: Medium - enables session-based debugging
- **Effort**: Medium - requires session service integration
- **Timeline**: Next sprint

### P2 (Nice to Have): X-Case-ID
- **Impact**: Low - case-specific tracking
- **Effort**: Low - simple passthrough
- **Timeline**: Future enhancement

## Related Files

**Agent Service**:
- [middleware.py](src/agent_service/infrastructure/logging/middleware.py) - Expects headers
- [context.py](src/agent_service/infrastructure/logging/context.py) - RequestContext usage

**API Gateway**:
- `/home/swhouse/product/fm-api-gateway/src/gateway/api/middleware.py` - AuthMiddleware
- `/home/swhouse/product/fm-api-gateway/src/gateway/api/routes.py` - proxy_request
- `/home/swhouse/product/fm-api-gateway/src/gateway/core/user_context.py` - UserContext headers

## Conclusion

The current implementation **works but is suboptimal**. The agent service logging infrastructure is correctly implemented and will function with the current API Gateway setup (using fallback UUID generation). However, **adding correlation ID forwarding** is highly recommended for production-grade distributed tracing.

**Action Items**:
1. ✅ Agent service ready (no changes needed - has fallback)
2. ⚠️ API Gateway needs correlation ID enhancement (P0)
3. ⚠️ Consider session ID forwarding (P1)
4. ⏳ Case ID passthrough optional (P2)

---

**Created**: 2025-11-24
**Author**: Claude Code
**Status**: Documentation for future enhancement
